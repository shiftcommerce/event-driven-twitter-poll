<!doctype html>
<html>
<head>
  <title>Event-driven Twitter Poll</title>
</head>

<body>
  <h1>
    Votes:
    <% vote_terms.each do |term| %>
      <span data-vote-for='<%= term.downcase %>'>0</span>
      for <%= term %>
    <% end %>
  </h1>

  <div id='votes'></div>

  <script src="https://js.pusher.com/4.1/pusher.min.js"></script>
  <script>
    // create a Pusher configuration
    var pusher = new Pusher('<%= ENV.fetch('PUSHER_APP_KEY') %>', {
      cluster: 'eu',
      encrypted: true
    });

    // connect to the `votes` channel
    var channel = pusher.subscribe('votes');

    // when we receive a vote
    channel.bind('vote', function handleMessage(value) {
      // update the counter
      var counter = document.querySelector(`[data-vote-for='${value.vote_for.toLowerCase()}']`);
      if (counter) counter.innerHTML = value.absolute;

      // add the message
      var votes_display = document.getElementById('votes');
      var vote_element = document.createElement('p');
      vote_element.innerHTML = `<p>@${value.screen_name} voted for ${value.vote_for}</p>`;
      votes_display.appendChild(vote_element);
    });
  </script>
</body>

</html>
